{% extends 'base.html' %}

{% block title %}{{ epic.title }}{% endblock %}

{% block content %}
<div class="header">
    <div>
        <a href="{% url 'epic-list' %}" style="text-decoration: none; color: var(--text-muted);">&larr; Quay l·∫°i danh s√°ch Epics</a>
        <h1 style="margin-top: 0.5rem;">{{ epic.title }}</h1>
        <p style="color: var(--text-muted); margin-top: -1rem;">{{ epic.description }}</p>
    </div>
    <button class="btn btn-dark" onclick="showCreateTaskModal()">+ Th√™m Task m·ªõi</button>
</div>

<h2>Danh s√°ch nhi·ªám v·ª•</h2>
<div id="task-list">
    {% for task in epic.tasks.all %}
    <div class="task-list-item" onclick="loadTaskDetail('{% url 'task-update' task.pk %}', {{ task.pk }})">
        <div>
            <p style="margin: 0; font-weight: 500;">{{ task.title }}</p>
            <small style="color: var(--text-muted);">
                üóìÔ∏è {{ task.start_day|date:"Y-m-d" }} &nbsp; ‚è≥ {{ task.duration }} ng√†y &nbsp; üìã Sub-tasks: {{ task.subtasks.count }}
            </small>
        </div>
        {% if task.status == 'COMPLETED' %}
            <span class="status-badge status-hoanthanh">Ho√†n th√†nh</span>
        {% elif task.status == 'IN_PROGRESS' %}
            <span class="status-badge status-dangthuchien">ƒêang th·ª±c hi·ªán</span>
        {% elif task.status == 'BLOCKED' %}
            <span class="status-badge status-chan">Ch·∫∑n</span>
        {% else %}
            <span class="status-badge status-chothuchien">Ch·ªù th·ª±c hi·ªán</span>
        {% endif %}
    </div>
    {% empty %}
    <p>Ch∆∞a c√≥ nhi·ªám v·ª• n√†o trong Epic n√†y.</p>
    {% endfor %}
</div>

<div id="createTaskModalContent" style="display:none;">
    <div class="modal-header">
        <h2>Th√™m Task m·ªõi</h2>
        <span class="close-btn" onclick="closeModal()">&times;</span>
    </div>
    <form id="task-create-form" action="{% url 'task-create' epic_pk=epic.pk %}" method="post">
        {% csrf_token %}
        <div class="modal-body" style="padding: 1rem;">
            <div class="form-group">
                <label for="id_title_create">T√™n nhi·ªám v·ª•</label>
                <input type="text" name="title" id="id_title_create" required>
            </div>
            <div class="form-group-inline">
                <div class="form-group">
                    <label for="id_start_day_create">Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input style="width: 80%" type="date" name="start_day" id="id_start_day_create" required>
                </div>
                <div class="form-group">
                    <label for="id_duration_create">Th·ªùi gian (ng√†y)</label>
                    <input type="number" name="duration" value="1" id="id_duration_create" required>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" onclick="closeModal()">H·ªßy</button>
            <button type="submit" class="btn btn-dark">Th√™m Task</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
 async function loadTaskDetail(url, taskId) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');

            const html = await response.text();
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = html;

            modalContent.dataset.currentTaskPk = taskId;

            openModal();
        } catch (error) {
            console.error('Failed to load task details:', error);
        }
    }

    async function addSubTask(taskPk) {
        const titleInput = document.getElementById('new-subtask-title');
        if (!titleInput || !titleInput.value) return;

        const csrfToken = document.querySelector('#taskUpdateForm [name=csrfmiddlewaretoken]').value;
        const formData = new FormData();
        formData.append('title', titleInput.value);
        formData.append('status', 'TODO');

        await fetch(`/task/${taskPk}/subtask/add/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
            body: formData,
        });

        await loadTaskDetail(`/task/${taskPk}/update/`, taskPk);
    }

    function handleStatusChange(selectElement, subtaskPk) {
        const selectedValue = selectElement.value;

        if (selectedValue === 'Xong') {
            selectElement.classList.remove('status-badge-chuaxong');
            selectElement.classList.add('status-badge-xong');
        } else {
            selectElement.classList.remove('status-badge-xong');
            selectElement.classList.add('status-badge-chuaxong');
        }

        updateSubTaskStatusOnServer(subtaskPk, selectedValue);
    }

    async function updateSubTaskStatusOnServer(subtaskPk, status) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const formData = new FormData();
        formData.append('status', status);

        try {
            await fetch(`/subtask/${subtaskPk}/update-status/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                body: formData,
            });
            console.log(`Subtask ${subtaskPk} status updated to ${status}`);
        } catch (error) {
            console.error('Failed to update subtask status:', error);
        }
    }

    async function deleteSubTask(subtaskPk) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nhi·ªám v·ª• con n√†y?')) {
        return;
    }

    const updateForm = document.getElementById('taskUpdateForm');
    const csrfToken = updateForm.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
        const response = await fetch(`/subtask/${subtaskPk}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.success) {
            const modalContent = document.getElementById('modalContent');
            const currentTaskPk = modalContent.dataset.currentTaskPk;

            if (currentTaskPk) {
                await loadTaskDetail(`/task/${currentTaskPk}/update/`, currentTaskPk);
            }
        } else {
            alert('X√≥a th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
        }

    } catch (error) {
        console.error('L·ªói khi x√≥a sub-task:', error);
        alert('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh x√≥a.');
    }
}

    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'add-subtask-btn') {
            const modalContent = document.getElementById('modalContent');
            const currentTaskPk = modalContent.dataset.currentTaskPk;

            if (currentTaskPk) {
                addSubTask(currentTaskPk);
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y Task ID hi·ªán t·∫°i tr√™n popup.");
            }
        }
    });

    function showCreateTaskModal() {
        const modalContent = document.getElementById('modalContent');
        const formHtml = document.getElementById('createTaskModalContent').innerHTML;
        modalContent.innerHTML = formHtml;
        document.getElementById('id_start_day_create').valueAsDate = new Date();
        openModal();
    }
</script>
{% endblock %}